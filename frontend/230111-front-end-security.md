# 前端安全：如何防止 XSS 攻击和保护用户隐私

## 一、什么是 XSS？

XSS（Cross-Site Scripting）是一种常见的 Web 应用程序安全漏洞，可以让攻击者在受害者的浏览器中注入恶意的客户端脚本，从而获得更多的权限。

XSS 攻击把攻击者的代码注入到网站或应用程序中，这些代码可以控制用户的浏览器，改变页面的内容，收集用户信息等。

## 二、XSS 的原理

XSS 攻击的原理是，当用户访问一个网站时，攻击者会在网站中植入恶意的 JavaScript 代码，这些恶意的 JavaScript 代码会被执行，从而实现攻击者的目的。

攻击者可以使用这些恶意的 JavaScript 代码来收集用户的敏感信息，窃取用户的账户和密码，甚至控制用户的浏览器，进行其他攻击。

## 三、XSS 的分类

XSS 攻击可以分为 3 类：存储型（持久型）、反射型（非持久型）、DOM 型。

### 1. 反射型 XSS

当用户点击一个恶意链接，或者提交一个表单，或者进入一个恶意网站时，注入脚本进入被攻击者的网站。
Web 服务器将注入脚本，比如一个错误信息，搜索结果等 返回到用户的浏览器上。
由于浏览器认为这个响应来自"可信任"的服务器，所以会执行这段脚本。

流量走向：浏览器——>后端——>浏览器

时序图

```Mermaid
sequenceDiagram
    participant 用户
    participant 应用程序
    participant 客户
    用户->>应用程序: 1.用户登录
    客户-->>用户: 2.攻击者将他自己准备的URL提交给客户
    用户->>应用程序: 3. 用户请求攻击者的URL
    应用程序-->>用户: 4. 服务器对攻击者的Javascript做出回应
    用户-->>用户: 5. 攻击者的JavaScript在用户的浏览器种执行
    用户->>客户: 6. 用户的浏览器像攻击者发送会话令牌(token)
    客户-->>应用程序: 7. 攻击者劫持用户会话（使用token登录）
```

### 2. 存储型 XSS

注入型脚本永久存储在目标服务器上。当浏览器请求数据时，脚本从服务器上传回并执行。

流量走向：浏览器——>后端——>数据库——>后端——>浏览器

### 3. DOM 型 XSS

DOM 型 XSS 是一种可以在客户端（浏览器）中执行的跨站脚本攻击，它利用了在网页中插入恶意代码的漏洞。

攻击者可以通过插入恶意代码来窃取用户的敏感信息，比如`登录凭据`，`修改网页`内容，或者`执行任意的指令`，从而损害用户的利益。

流量走向：URL——>浏览器

## 四、XSS 的防御技术

1. 对数据进行转义处理：将特殊字符转义成 HTML 实体，从而防止攻击者插入恶意代码。

2. 验证用户输入：对用户提交的数据进行格式验证，以过滤掉不合要求的输入，防止攻击者插入恶意代码。

3. 使用 HTTPOnly 标记：在 Cookie 中设置 HTTPOnly 标记，使得 Cookie 不能被客户端脚本访问，从而防止攻击者利用 XSS 漏洞获取 Cookie 信息。

4. 使用 `Content Security Policy`：通过设置 Content Security Policy，可以限制浏览器加载的脚本文件，从而防止攻击者利用 XSS 漏洞注入恶意代码。

## 五、XSS 的实战案例

1. 攻击者在网站注册一个用户，用户名设置为`<script>alert('XSS')</script>`，当其他用户浏览这个用户的个人主页时，就会弹出一个 XSS 的警告框。

2. 攻击者在网站的搜索框中输入`<script>alert('XSS')</script>`，当用户点击搜索按钮时，就会弹出一个 XSS 的警告框。

3. 攻击者在网站的评论框中输入`<script>alert('XSS')</script>`，当用户点击发表评论按钮时，就会弹出一个 XSS 的警告框。

## 六、XSS 的总结

前端安全是非常重要的一个问题，在防止 XSS 攻击和保护用户隐私方面有很多技巧可以使用。

### 防止 XSS 攻击:

- 对用户输入的数据进行转义，使其不能包含恶意代码。
- 使用 `Content Security Policy (CSP)` 限制网页可以加载的资源。
- 通过 `HttpOnly` 和 `secure` 标志设置 `cookie`。
- 避免在页面上使用 `eval()` 和其他动态代码执行函数。

### 保护用户隐私:

- 使用 HTTPS 保证数据传输的安全性。
- 避免将敏感信息存储在浏览器中，如果必须存储，请使用加密存储。
- 客户端使用授权令牌来保护敏感资源。

## 参考链接

百度百科 https://baike.baidu.com/item/XSS

MDN Cross-site scripting（跨站脚本攻击） https://developer.mozilla.org/zh-CN/docs/Glossary/Cross-site_scripting

Excess XSS https://excess-xss.com/

翻译后 http://qingbob.com/Excess-XSS/
